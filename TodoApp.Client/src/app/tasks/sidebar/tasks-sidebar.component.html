<aside
  class="flex h-full min-h-0 flex-col rounded-3xl border border-stroke bg-card shadow-card backdrop-blur overflow-hidden">
  <div class="relative">
    <div class="rounded-t-2xl border border-stroke bg-white px-4 py-2">
      <div class="flex items-start justify-between">
        <div>
          <p class="mt-1 text-lg font-semibold text-ink-900">
            {{ user?.nickname ?? '–' }}
          </p>
        </div>

        <div class="relative">
          <button
            #profileBtn
            class="flex h-9 w-9 items-center justify-center rounded-full border border-stroke text-lg text-ink-700 transition hover:border-mint-500/50 hover:text-mint-600"
            type="button"
            (click)="openProfileMenu(profileBtn, profileMenuTpl)"
          >
            ⋯
          </button>

          <ng-template #profileMenuTpl>
            <div class="w-40 rounded-2xl border border-stroke bg-white p-2 shadow-card popover-panel">
              <a
                class="block rounded-xl px-3 py-2 text-sm font-semibold text-ink-700 hover:bg-sand-50"
                routerLink="/me"
                (click)="closePopover()"
              >
                Account
              </a>

              <button
                class="mt-1 w-full rounded-xl px-3 py-2 text-left text-sm font-semibold text-danger-600 hover:bg-danger-600/10 disabled:opacity-60"
                type="button"
                (click)="logoutFromPopover()"
                [disabled]="loggingOut()"
              >
                {{ loggingOut() ? 'Signing out...' : 'Logout' }}
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <div class="flex-1 min-h-0 overflow-y-auto p-2 space-y-2">
    <section class="rounded-2xl border border-stroke bg-white p-4">

      <div class="flex items-center justify-between">
        <span class="text-sm font-semibold uppercase tracking-wide text-ink-700">
          Categories
        </span>

        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-full border border-stroke bg-white p-1 py-0.5">
            <button
              type="button"
              class="rounded-full px-3 py-1 text-sm font-semibold transition"
              [class.bg-ink-900]="categoryFilter === 'all'"
              [class.text-white]="categoryFilter === 'all'"
              (click)="categoryChange.emit('all')"
            >
              All
            </button>

            <button
              type="button"
              class="rounded-full px-3 py-1 text-sm font-semibold transition"
              [class.bg-ink-900]="categoryFilter === 'none'"
              [class.text-white]="categoryFilter === 'none'"
              (click)="categoryChange.emit('none')"
            >
              No category
            </button>
          </div>

          <button
            #addCategoryBtn
            type="button"
            title="Add category"
            class="flex h-9 w-9 shrink-0 items-center justify-center
                 rounded-full border border-stroke
                 text-lg font-semibold text-ink-500
                 hover:bg-sand-50 hover:text-ink-700
                 transition"
            (click)="openAddCategory(addCategoryBtn)"
          >
            +
          </button>

          <ng-template #addCategoryTpl>
            <app-category-form
              [form]="categoryForm"
              [formClass]="'w-64 rounded-xl border border-stroke bg-white p-3 shadow-card popover-panel'"
              [inputClass]="'w-full rounded-lg border border-stroke px-3 py-2 text-sm text-ink-900 focus:border-mint-600/60 focus:shadow-focus focus:outline-none'"
              [placeholder]="'Category name'"
              [submitLabel]="'Add'"
              [cancelLabel]="'Cancel'"
              [showActions]="true"
              [showValidation]="false"
              [disableSubmit]="categoryForm.invalid || savingCategory"
              (submitForm)="addCategory.emit()"
              (cancel)="closePopover()"
            ></app-category-form>
          </ng-template>
        </div>
      </div>

      <div class="mt-4 space-y-2">
        @if (loadingCategories) {
          <div class="text-sm text-ink-500">Loading categories...</div>
        } @else if (!categories.length) {
          <div class="text-sm text-ink-500">No categories yet.</div>
        } @else {
          @for (cat of categories; track cat.id) {
            <div
              class="relative rounded-xl border border-stroke px-3 py-2"
              [ngClass]="activeCategoryId === cat.id ? 'border-mint-500 bg-mint-500/10' : ''"
            >
              @if (editingCategoryId === cat.id) {
                <div class="fixed inset-0 z-10"
                     (click)="cancelEditCategory.emit()"
                ></div>

                <div class="relative z-10">
                  <app-category-form
                    [form]="categoryEditForm"
                    [formClass]="'space-y-2'"
                    [inputClass]="'w-full rounded-lg border border-stroke px-2 py-1 text-sm text-ink-900 shadow-sm focus:border-mint-600/60 focus:shadow-focus focus:outline-none'"
                    [placeholder]="''"
                    [showActions]="false"
                    [showValidation]="true"
                    (inputEnter)="saveEditCategory.emit()"
                    (inputEscape)="cancelEditCategory.emit()"
                  ></app-category-form>
                </div>
              } @else {
                <div class="flex items-center justify-between gap-2">
                  <button
                    class="flex-1 text-left text-sm font-semibold text-ink-900"
                    type="button"
                    (click)="categoryChange.emit(cat.id)"
                  >
                    {{ cat.name }}
                  </button>

                  <div class="relative">
                    <button
                      #menuBtn
                      class="flex h-8 w-8 items-center justify-center rounded-full border border-stroke"
                      type="button"
                      (click)="openCategoryMenu(menuBtn, categoryMenuTpl, cat)"
                    >
                      ⋯
                    </button>

                    <ng-template #categoryMenuTpl let-cat="cat">
                      <div class="w-32 rounded-2xl border border-stroke bg-white p-2 shadow-card popover-panel">
                        <button
                          class="w-full rounded-xl px-3 py-2 text-left text-sm font-semibold hover:bg-sand-50"
                          type="button"
                          (click)="onEdit(cat)"
                        >
                          Edit
                        </button>

                        <button
                          class="mt-1 w-full rounded-xl px-3 py-2 text-left text-sm font-semibold text-danger-600 hover:bg-danger-600/10"
                          type="button"
                          (click)="onDelete(cat.id)"
                        >
                          Delete
                        </button>
                      </div>
                    </ng-template>
                  </div>
                </div>
              }
            </div>
          }
        }
      </div>
    </section>
    <section class="rounded-2xl border border-stroke bg-white p-4">
      <h3 class="text-sm font-semibold text-ink-500 uppercase tracking-wide">
        Recent tasks
      </h3>

      @if (loadingRecent) {
        <div class="mt-3 text-sm text-ink-500/70">Loading…</div>
      } @else if (!recentTasks.length) {
        <div class="mt-3 text-sm text-ink-500/70">No recent tasks</div>
      } @else {
        <ul class="mt-2 space-y-1">
          @for (task of recentTasks; track task.id) {
            <li>
              <button
                class="flex w-full items-center justify-between gap-2
                       rounded-lg px-2 py-1.5
                       text-sm text-ink-700
                       hover:bg-sand-50 transition"
                [ngClass]="task.id === selectedTaskId ? 'bg-mint-500/10 text-mint-600' : ''"
                (click)="selectTask.emit(task.id)"
              >
                <span class="truncate">
                  {{ task.title }}
                </span>
                <span class="shrink-0 text-xs text-ink-500/70">
                  {{ task.updatedAt ?? task.createdAt | date:'short' }}
                </span>
              </button>
            </li>
          }
        </ul>
      }
    </section>
  </div>
</aside>
